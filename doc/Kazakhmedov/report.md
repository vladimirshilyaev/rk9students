#Морфологические операции над изображениями. Фильтры и их назначение  
**ВВЕДЕНИЕ**  
  
В данной статье речь пойдёт об операциях математической морфологии и матричных фильтрах обработки изображений, инструменты которых пригодятся для обработки томографических снимков.  
Прежде чем приступить к рассмотрению морфологических операций и фильтров, вспомним о представлении графической информации на компьютере. Изображение состоит из точек, навзываемые пикселями. Каждый пиксель является носителем информации (см. Рисунок 1), которая  представляется в виде одной из двух цифр: 0 (белый цвет) или 1 (черный цвет).  
![Рис. 1] (http://dxmbkxacdb7tv.cloudfront.net/78fbe751-cc01-4715-b6ab-898ab124085f/rastr.png "Представление чёрно-белого изображения")  
 Рисунок 1  
 
 ![](/images/image.png) 
 
 Математическая морфология используется для извлечения свойств изображения, полезных для его представления и описания. Входными данными для аппарата математической морфологии являются два изображения: обрабатываемое и специальное, зависящее от вида операции и решаемой задачи. Такое специальное изображения принято называть примитивом или структурным элементом. Структурный элемент представляет собой область в виде геометрической фигуры. Геометрия такой фигуры может быть любой, главное, чтобы её можно было представить в виде бинарного изображения заданного размера. Во многих пакетах обработки изображений наиболее распространенные структурные элементы имеют специальные названия: BOX[H,W] –прямоугольник заданного размера, DISK[R] — диск заданного размера, RING[R] – кольцо заданного размера (см. Рисунок 2).  
![Рис. 2] (https://habrastorage.org/storage/habraeffect/cb/ec/cbec75eb1a466759d06eae30096be5b9.jpg "Типовые структурные элементы")  
 Рисунок 2   
 
 Одно из главных достоинств морфологической обработки - её простота: как на входе, так и на выходе мы получаем бинаризированное изображение.  
Матричные фильтры обработки изображений позволяют получать на выходе изображение со свойствами, отличными от исходного. В основе работы каждого из фильтров лежит использование матрицы свертки, о которой пойдёт речь в соответствующем разделе. Далее разберёмся в принципе работы каждого из фильтров более подробно.  

**1. Морфологические операции**  

Всего существует 4 основных морфологических операций: наращивание, эрозия, замыкание и размыкание. При детальном рассмотрении каждой из операций, мы будем использовать изображение и структурный элемент, показанные на рисунке 3.  
![Рис. 3] (https://habrastorage.org/storage/habraeffect/34/d9/34d9a9806f49f263ae78360d5a0ffce4.jpg "Изображение и структурный элемент")  
 Рисунок 3   
 
 Важно отметить, что начало координат выбранного структурного элемента находится в центре (см. рисунок 4)  
 
 ![Рис. 4] (http://homepages.inf.ed.ac.uk/rbf/HIPR2/figs/kern3x3.gif "Перенос")  
 Рисунок 4 

_1.1. Перенос_  

Операция переноса Xt множества пикселов X на вектор t задаётся в виде Xt={x+t|x∈X}. Следовательно, перенос множества единичных пикселов на бинарном изображении сдвигает все пикселы множества на заданное расстояние. Вектор переноса t может задаваться в виде упорядоченной пары (∆r,∆c), где ∆r – компонент вектора переноса в направлении строк, а ∆c — компонент вектора переноса в направлении столбцов изображения.  
![Рис. 5] (https://habrastorage.org/storage/habraeffect/f1/f4/f1f4c6f5cf09770adcf8f6de3e8aebfe.jpg "Перенос")  
 Рисунок 5   
 
 _1.2. Наращивание_  
 
 Обратимся к рисунку 3. Операция наращивания применяется к каждому пикселю. Происходит весь процесс следующим образом: начало координат структурного элемента (СЭ) совмещается с каждым пикселем исходного изображения. Если на пути начала координат СЭ встречается пиксель аналагичного цвета, то происходит операция объединения между СЭ и исходным изображением. Результаты логического сложения записываются в выходное бинарное изображение (см. рисунок 5).  
 ![Рис. 6] (https://habrastorage.org/storage/habraeffect/ec/1c/ec1ce5ba7960d870d89894eadcaf97f3.jpg "Наращивание")  
 Рисунок 6  
 
 _1.3. Эрозия_  
 
 При выполнении операции эрозии структурный элемент тоже проходит по всем пикселам изображения. Если в некоторой позиции каждый единичный пиксел структурного элемента совпадет с единичным пикселом бинарного изображения, то выполняется логическое сложение центрального пиксела структурного элемента с соответствующим пикселом выходного изображения (см. рисунок 7).  
 
 ![Рис. 7] (https://habrastorage.org/storage/habraeffect/39/3f/393f68871e0791a6ad513b35a85285f4.jpg "Эрозия")  
 Рисунок 7  
 
 В результате применения операции эрозии все объекты, меньшие чем структурный элемент, стираются, размеры всех объектов уменьшаются.
 
  _1.4. Разамыкание_  
  
 Операция эрозии полезна для удаления малых объектов и различных шумов, но её недостаток – уменьшение всех оставшихся объектов в размере. Этого эффекта можно избежать, если после операции эрозии применить операцию наращивания с тем же структурным элементом.
 Размыкание отсеивает все объекты, меньшие чем структурный элемент, но при этом помогает избежать сильного уменьшения размера объектов. Также размыкание идеально подходит для удаления линий, толщина которых меньше, чем диаметр структурного элемента. После выполнения этой операции контуры объектов становятся более гладкими.  
 
 ![Рис. 8] (https://habrastorage.org/storage/habraeffect/9f/26/9f264273d5726d3e08abd00f50954522.jpg "Размыкание")  
 Рисунок 8  
 
  _1.5. Замыкание_  
  
  Операция замыкания практически идентична размыканию, за исключением того, что вначале выполняется операция наращивания, а потом эрозии. Замыкание позволяет избавиться от малых дыр и щелей при сохранении тех же размеров контуров объекта (см. рисунок 9).  
  
  ![Рис. 9] (https://habrastorage.org/storage/habraeffect/bd/11/bd1116a7776e640d37590b9165180d8c.jpg "Замыкание")  
 Рисунок 9  
 
 **2. Применение бинарной морфологии**  
 
 Примером реального применения морфологических операций является выделение границ объекта. Эта операция является весьма важной, поскольку она позволяет весьма компактно и полно привести полное описание объекта.  
 Легко заметить, что граничные точки имеют как минимум один фоновый пиксел в своей окрестности. Таким образом, применив оператор эрозии с структурным элементом, содержащим все возможные соседние элементы, мы удалим все граничные точки… Тогда граница получится с помощью операции разности множеств между исходным изображением и изображением, полученным в результате эрозии (см. рисунок 10).  
 
 ![Рис. 10] (https://habrastorage.org/storage/habraeffect/94/32/9432d2e3f1082480e62c8d4de050e120.jpg "Выделение границ")  
 Рисунок 10  
 
  **3. Матричные фильтры обрабоки изображений**  
  
   _3.1. Матрица свёртки_  
   
   Матрица свёртки – это матрица коэффициентов, которая «умножается» на значение пикселей изображения для получения требуемого результата. Алгоритм применения следующий. Начиная с верхнего левого пикселя, выделяем ядро размером матрицы свертки (см. рисунок 11). 
   
  ![Рис. 11] (http://www.mathworks.com/help/vision/ref/2d_conv_diagram.png "Применение матрицы свертки")  
 Рисунок 11  
 
 Проводим перемножение между элементами матрицы свертки и выделенного ядра. Для примера, показанного на рисунке 11, результат будет следующим: 0⋅2+0⋅9+0⋅4+0⋅7+17⋅5+24⋅3+0⋅6+23⋅1+5⋅8=220. Далее вычисляем коэффициент нормирования, суммируя компоненты матрицы свёртки. Для нашего примера это значение будет равно 45. Результат перемножения матриц делим на коэффициент нормирования: 220:45=4.89. Полученное значение присваиваем центральному компоненту ядра. Весь цикл проделываем для каждого пикселя изображения.
   
   _3.2. Фильтр размытия_  
   
Наиболее часто используемым фильтром, основанным на матрице свёртки, является фильтр размытия.
Обычно матрица заполняется по нормальному (гауссовому закону). Ниже приведена матрица размытия 5x5 заполненная по закону Гауссовского распределения.  

![Маьрица] (https://habrastorage.org/getpro/habr/post_images/be3/833/80e/be383380e8906ea37e3815c05dbfeaf3.png "Матрица свёртки")  
 
 Важно отметить, что сумма элементов матрицы равна 1, поэтому и коэффициент нормирования так же равен 1. Сила размытия изображения зависит от размера матрицы свёртки (см. рисунок 13).  
 
 ![Рис. 12] (https://habrastorage.org/getpro/habr/post_images/0be/1b7/f45/0be1b7f45cc0f54ff0f79c90fac4114b.png "Размытие изображения")  
 Рисунок 12  
 
 Стоит также сказать пару слов о недостатке фильтра размытия, да и вообще всех фильтров, использующих матрицу свертки. Дело в том, что у верхнего левого пикселя отсутствует сосед справа от него, следовательно, нам не на что умножать коэффициенты матрицы. Решений для этой проблемы существует несколько, но мы ограничимся рассмотрением лишь одного из них, поскольку этот метод не будет влиять на качество обрабатываемых изображений, а для томографических снимков, которые мы будем использовать, это очень важно. Идея состоит в создании временного изображения с размерами (width + 2 * kernelSize / 2, height + 2 * kernelSize / 2, где kernelSize - размер матрицы свертки, width, height - ширина и высота изображения соответственно). В центр изображения копируется входная картинка, а края заполняются крайними пикселями изображения. Размытие применяется к промежуточному буферу, а потом из него извлекается результат (см. рисунок 14).  
 
 ![Рис. 13] (https://habrastorage.org/getpro/habr/post_images/d03/7d9/16c/d037d916ce82754636b3154fd9b7d6bb.png "Решение проблемы")  
 Рисунок 13 
    
   _3.3. Фильтр улучшения чёткости_  
   
 Для повышения чёткости изображения используется следующая матрица:  
 
 ![Чётко] (https://habrastorage.org/getpro/habr/post_images/0b9/a96/f5b/0b9a96f5b5883b622c89ef81c3315947.png "Матрица чёткости")  
 
 Применение фильтра позволяет увеличить разницу на границах. Важно отметить, что коэффициент нормирования данной матрицы равен 1. Пример улучшения чёткости изображения приведён на рисунке 14.  
 
 ![Рис. 14] (https://habrastorage.org/getpro/habr/post_images/e31/b47/fe4/e31b47fe48c70d4fc5d40a621c5b62e5.png "Улучшение чёткости")  
 Рисунок 14
     
  _3.4. Медианный фильтр_  
  
 Медианный фильтр обычно используется для уменьшения шума или «сглаживания» изображения. Фильтр работает с матрицами различного размера, но в отличие от матрицы свёртки, размер матрицы влияет только на количество рассматриваемых пикселей, т.е., если предыдущие фильтры занимались тем, что перемножали матрицы друг на друга, то в данном случае, размер и сама матрица свёртки нужны лишь для того, чтобы определить размеры рассматриваемого ядра. Действие медианного фильтра изображено на рисунке 15.  
 
![Рис. 15] (https://habrastorage.org/getpro/habr/post_images/e31/b47/fe4/e31b47fe48c70d4fc5d40a621c5b62e5.png "Сглаживание")  
 Рисунок 15  
 
 Алгоритм медианного фильтра следующий: для текущего пикселя, пиксели, которые «попадают» в матрицу, сортируются, и выбирается средние значение из отсортированного массива. Это значение и является выходным для текущего пикселя. Данный алгоритм подобен поиску медианы в числовой выборке, отсюда и название, медианный фильтр. Ниже приведена иллюстрация алгоритма.  
 
 ![Алгоритм] (https://habrastorage.org/getpro/habr/post_images/ff1/2a7/a29/ff12a7a29b9c55785a7f5893738b9bdb.png "Алгоритм медианного фильтра")  

   
   **4. Заключение**  
   
 В данной статье были рассмотрены математическая морфология и матричные фильтры обработки изображений, использование которых позволит обработать томографические снимки.
